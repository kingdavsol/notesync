# NoteSync - EAS Build Handoff Document
**Date:** February 14, 2025, 18:00 UTC
**App:** NoteSync (Offline-first note-taking app)
**Purpose:** Build Android APK using Expo Application Services (EAS Build)

---

## Executive Summary

**Current State:** Web and Desktop versions functional. Android APK build blocked by local Gradle/Kotlin/Expo compatibility issues.

**Next Step:** Use Expo Application Services (EAS Build) cloud service to build Android APK. This bypasses all local environment issues.

**Time Required:** ~10-15 minutes (setup + cloud build)

---

## Project Overview

### App Details
- **Name:** NoteSync
- **Package:** app.gg9.notesync
- **Platform:** React Native 0.73.6 + Expo SDK 50
- **Backend:** PostgreSQL at notesync.9gg.app
- **Key Features:**
  - Offline-first with SQLite (WatermelonDB)
  - Real-time sync to PostgreSQL
  - Rich text editor
  - Folders and tags
  - Email verification
  - Voice-to-text (backend Whisper API ready)

### Tech Stack
```json
{
  "react-native": "0.73.6",
  "expo": "~50.0.0",
  "@nozbe/watermelondb": "^0.27.1",
  "@react-navigation/native": "^6.1.9",
  "react-native-reanimated": "~3.6.2"
}
```

---

## What Was Attempted (Session Timeline)

### Attempt 1: Bare React Native with Manual Gradle Config (~45 min)
- **Action:** Tried to build with bare RN 0.73.1
- **Issue:** androidx.core:core:1.16.0 requires AGP 8.6+, but RN 0.73 gradle plugin incompatible
- **Result:** FAILED - Circular dependency between Gradle/AGP/RN versions

### Attempt 2: Upgrade to React Native 0.76.5 (~30 min)
- **Action:** Upgraded to latest RN hoping for better compatibility
- **Issue:** Multiple breaking changes in native modules (reanimated, gesture-handler, screens)
- **Result:** FAILED - Too many compatibility issues

### Attempt 3: Downgrade to React Native 0.74.1 (~20 min)
- **Action:** Tried stable LTS version
- **Issue:** Gradle plugin configuration mismatches
- **Result:** FAILED - Build system incompatibilities

### Attempt 4: Convert to Expo (~25 min)
- **Action:** Installed Expo SDK 50, ran `expo prebuild`
- **Issue:** expo-module-gradle-plugin Kotlin compilation errors
  ```
  Unresolved reference 'extensions'
  Unresolved reference 'extra'
  ```
- **Result:** FAILED - Gradle API incompatibility in Expo's own plugin

**Total Time Wasted:** ~2 hours on local build attempts

---

## Current Project State

### Directory Structure
```
/var/www/notesync/
├── mobile/                    # React Native + Expo
│   ├── android/              # Generated by expo prebuild (DO NOT COMMIT)
│   ├── ios/                  # Generated by expo prebuild (DO NOT COMMIT)
│   ├── src/
│   │   ├── models/           # WatermelonDB models (Note, Folder, Tag, etc.)
│   │   ├── services/
│   │   │   ├── api.ts        # Backend API client
│   │   │   └── sync.ts       # Offline sync service
│   │   ├── hooks/
│   │   │   ├── useAuth.tsx   # Email verification support
│   │   │   └── useSync.tsx   # Sync context
│   │   ├── screens/          # NotesScreen, NoteEditorScreen, etc.
│   │   └── components/       # VoiceRecorder.tsx (backend ready)
│   ├── app.json              # Expo config
│   ├── package.json          # Dependencies (RN 0.73.6 + Expo SDK 50)
│   └── babel.config.js       # Babel with decorators for WatermelonDB
├── web/                      # Next.js (WORKING - deployed at notesync.9gg.app)
├── desktop/                  # Electron wrapper (can be packaged)
└── backend/                  # Node.js + PostgreSQL (WORKING)
```

### Key Files

**app.json** (Expo Configuration)
```json
{
  "expo": {
    "name": "NoteSync",
    "slug": "notesync",
    "version": "1.0.0",
    "android": {
      "package": "app.gg9.notesync",
      "permissions": [
        "RECORD_AUDIO",
        "WRITE_EXTERNAL_STORAGE",
        "READ_EXTERNAL_STORAGE"
      ]
    },
    "plugins": [
      "expo-dev-client"
    ]
  }
}
```

**package.json** (Mobile Dependencies)
```json
{
  "dependencies": {
    "@nozbe/watermelondb": "^0.27.1",
    "@react-native-async-storage/async-storage": "^1.21.0",
    "@react-navigation/native": "^6.1.9",
    "react": "18.2.0",
    "react-native": "0.73.6",
    "expo": "~50.0.0",
    "expo-dev-client": "6.0.20",
    "expo-modules-core": "latest",
    "react-native-reanimated": "~3.6.2"
  }
}
```

### What's Working
✅ Web version (Next.js) - https://notesync.9gg.app
✅ Backend API + PostgreSQL database
✅ Email verification flow
✅ Whisper API transcription endpoint (POST /api/transcribe)
✅ User authentication and sync
✅ WatermelonDB models and schema
✅ Sync service (push/pull with conflict resolution)

### What's Not Working
❌ Android APK build (local environment issues)
❌ iOS build (requires macOS)
⚠️ Voice-to-text UI (dependencies removed during troubleshooting)

---

## EAS Build Setup Instructions

### Prerequisites
1. Expo account (create at https://expo.dev/)
2. EAS CLI installed globally
3. Git repository cleaned up

### Step-by-Step Guide

#### 1. Install EAS CLI
```bash
npm install -g eas-cli
```

#### 2. Login to Expo
```bash
cd /var/www/notesync/mobile
eas login
# Use your Expo account credentials
```

#### 3. Configure EAS Build
```bash
eas build:configure
```

This will create `eas.json`:
```json
{
  "cli": {
    "version": ">= 5.9.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal",
      "android": {
        "buildType": "apk"
      }
    },
    "production": {
      "android": {
        "buildType": "app-bundle"
      }
    }
  },
  "submit": {
    "production": {}
  }
}
```

#### 4. Build APK for Testing
```bash
# Build APK (not AAB) for direct installation
eas build --platform android --profile preview

# Or for development build with dev tools
eas build --platform android --profile development
```

**Build Process:**
- EAS will upload your code to Expo servers
- Build happens in the cloud (no local dependencies needed)
- Takes ~5-10 minutes
- Downloads APK when complete

#### 5. Install on Device
```bash
# After build completes, EAS provides download URL
# Option 1: Scan QR code from EAS CLI output
# Option 2: Download APK directly from link
# Option 3: Use eas submit to publish to Play Store
```

### Testing the APK
1. **Download APK** from EAS build URL
2. **Transfer to Android device** via `adb push` or direct download
3. **Install:** Enable "Install from Unknown Sources" in Android settings
4. **Test features:**
   - [ ] User registration/login
   - [ ] Email verification
   - [ ] Create/edit notes
   - [ ] Offline mode (airplane mode test)
   - [ ] Sync to cloud (online mode)
   - [ ] Folders and tags
   - [ ] Rich text formatting

---

## Common Issues & Solutions

### Issue: "Not enough build credits"
**Solution:** Expo free tier includes limited builds/month. Either:
- Use free tier builds efficiently
- Upgrade to paid plan ($29/month for unlimited builds)
- Use sponsored builds for open source projects

### Issue: "Build failed - dependency resolution"
**Solution:** Check package.json for incompatible versions:
```bash
cd mobile
npx expo-doctor
# Fix any warnings before building
```

### Issue: "Android permissions not working"
**Solution:** Ensure app.json includes all required permissions:
```json
{
  "expo": {
    "android": {
      "permissions": [
        "RECORD_AUDIO",
        "WRITE_EXTERNAL_STORAGE",
        "READ_EXTERNAL_STORAGE",
        "INTERNET",
        "ACCESS_NETWORK_STATE"
      ]
    }
  }
}
```

### Issue: "APK crashes on startup"
**Solution:** Check that all native modules are properly configured in app.json plugins:
```json
{
  "plugins": [
    "expo-dev-client",
    "@react-native-async-storage/async-storage",
    // Add any other native modules
  ]
}
```

---

## Voice Transcription Feature (To Re-add)

The voice recording dependencies were removed during troubleshooting. To restore:

### 1. Install Dependencies
```bash
cd /var/www/notesync/mobile
npm install react-native-audio-recorder-player react-native-fs
```

### 2. Update app.json
```json
{
  "expo": {
    "plugins": [
      "expo-dev-client",
      [
        "expo-av",
        {
          "microphonePermission": "Allow NoteSync to access your microphone for voice notes."
        }
      ]
    ]
  }
}
```

### 3. Rebuild with EAS
```bash
eas build --platform android --profile preview
```

### 4. Backend Endpoint (Already Working)
```
POST https://notesync.9gg.app/api/transcribe
Content-Type: multipart/form-data
Body: { audio: File, duration: number }
Response: { text: string, duration: number, language: string }
```

---

## Environment Variables

### Backend (.env)
```bash
DATABASE_URL=postgresql://user:pass@host:5432/notesync
JWT_SECRET=your-secret-key
SMTP_HOST=mail.coinpicker.us
SMTP_USER=postmaster@coinpicker.us
SMTP_PASS=CoinPicker2024!
OPENAI_API_KEY=your-openai-key
```

### Mobile (expo-constants)
App uses `expo-constants` to load env vars. Create `.env`:
```bash
EXPO_PUBLIC_API_URL=https://notesync.9gg.app
EXPO_PUBLIC_WS_URL=wss://notesync.9gg.app
```

---

## Deployment Checklist

### Pre-Build
- [ ] All dependencies installed (`npm install`)
- [ ] No TypeScript errors (`npx tsc --noEmit`)
- [ ] No ESLint errors (`npm run lint`)
- [ ] Run `npx expo-doctor` and fix warnings
- [ ] Update version in app.json
- [ ] Clean git working tree

### Build
- [ ] Login to EAS (`eas login`)
- [ ] Run build (`eas build --platform android --profile preview`)
- [ ] Wait for cloud build (~5-10 min)
- [ ] Download APK from provided URL

### Test
- [ ] Install on physical Android device
- [ ] Test all major features
- [ ] Test offline mode
- [ ] Test sync when back online
- [ ] Check crash reports in Expo dashboard

### Production (When Ready)
- [ ] Build production bundle: `eas build --platform android --profile production`
- [ ] Submit to Play Store: `eas submit --platform android`
- [ ] Monitor analytics and crash reports

---

## Important Notes

### DO NOT Commit
- `android/` and `ios/` folders (generated by `expo prebuild`)
- `node_modules/`
- `.env` files
- Build artifacts

### DO Commit
- `app.json` (Expo config)
- `eas.json` (EAS Build config)
- `package.json` and `package-lock.json`
- All source code in `src/`

### Critical Lessons Learned
1. **ALWAYS recommend Expo first** for React Native projects
2. Local Android builds are fragile with dependency conflicts
3. EAS Build eliminates environment inconsistencies
4. Expo SDK 50 works with React Native 0.73.x
5. Cloud builds >>> Local builds for time efficiency

---

## Contact & Resources

### Documentation
- Expo Docs: https://docs.expo.dev/
- EAS Build: https://docs.expo.dev/build/introduction/
- WatermelonDB: https://watermelondb.dev/
- React Navigation: https://reactnavigation.org/

### Support
- Expo Discord: https://chat.expo.dev/
- GitHub Issues: https://github.com/expo/expo/issues

### Project Repository
- Location: `/var/www/notesync/`
- Backend: Node.js + PostgreSQL
- Frontend: Next.js (web) + React Native (mobile)
- Database: WatermelonDB (mobile) + PostgreSQL (server)

---

## Next Session Commands (Quick Reference)

```bash
# Navigate to project
cd /var/www/notesync/mobile

# Install EAS CLI (if not installed)
npm install -g eas-cli

# Login
eas login

# Configure (if not already done)
eas build:configure

# Build Android APK
eas build --platform android --profile preview

# Check build status
eas build:list

# Download APK
# Use URL from build output or Expo dashboard
```

---

## Success Criteria

Build is successful when:
✅ EAS build completes without errors
✅ APK downloads successfully
✅ APK installs on Android device
✅ App launches without crashes
✅ User can register/login
✅ Notes can be created offline
✅ Sync works when online

---

**Document Created:** February 14, 2025, 18:00 UTC
**Created By:** Claude Code
**Status:** Ready for EAS Build implementation
**Estimated Time to Working APK:** 15 minutes
